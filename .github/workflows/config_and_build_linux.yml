name: Build Linux Distribution

on:
  workflow_dispatch:

permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0'

      - name: Cleanup previous distribution directory
        run: |
          rm -rf "${{ github.workspace }}/App"

      - name: Setup Distribution Directory
        run: |
          mkdir -p "${{ github.workspace }}/App"
          mkdir -p "${{ github.workspace }}/App/Backend"

      - name: Publish ASP.NET Core Backend
        run: |
          dotnet publish ./apiPB/apiPB.csproj --configuration Release --output ${{github.workspace}}/App/Backend --runtime linux-x64 --self-contained true /p:UseAppHost=true
      
      - name: Copy Frontend files in wwwroot
        run: |
          if [ -d "${{ github.workspace }}/App/Backend" ]; then
            mkdir -p "${{ github.workspace }}/App/Backend/wwwroot"
            cp -r "${{ github.workspace }}/Frontend/"* "${{ github.workspace }}/App/Backend/wwwroot/"
          else
            echo "Error: Backend directory not found."
            exit 1
          fi

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build SH
        run: |
          cd BuildScripts
          pyinstaller --onefile --add-data "script_utils.py:." --add-data "build.json:." build.py

      - name: Move EXE to distribution directory and cleanup
        run: |
          mv BuildScripts/dist/build "${{ github.workspace }}/App"
          rm -rf BuildScripts/build BuildScripts/dist BuildScripts/__pycache__
          rm -rf BuildScripts/build.spec
      
      - name: Copy documentation to distribution directory
        run: |
          cp -r "${{ github.workspace }}/Docs/"* "${{ github.workspace }}/App"

      - name: Copy configuration file to distribution directory
        run: |
          cp "${{ github.workspace }}/BuildScripts/build.json" "${{ github.workspace }}/App/build.json"

      - name: Upload artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: PietribiasiApp-Distribution
          path: App/
          retention-days: 30
