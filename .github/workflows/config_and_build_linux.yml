name: Build Python to sh Linux

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build sh in Docker with old GLIBC (Debian Bullseye)
        run: |
            docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app/BuildScripts \
            --user $(id -u):$(id -g) \
            python:3.10-bullseye bash -c "\
                pip install pyinstaller && \
                pyinstaller --onefile \
                --add-data 'script_utils.py:.' \
                --add-data 'build.json:.' \
                build.py"


      - name: Move sh to root and cleanup
        run: |
          rm -f build.sh || true
          mv BuildScripts/dist/build build.sh
          chmod +x build.sh
          rm -rf BuildScripts/dist
          rm -rf BuildScripts/build
          rm -f BuildScripts/build.spec

      - name: Commit and push executable
        run: |
          git config --local user.email "raul.pianon@studenti.unipd.it"
          git config --local user.name "RaulPianon"
          git add build.sh
          git commit -m "Auto-build: Updated build.sh" || exit 0
          git push

      - name: Upload artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: config-generator
          path: build.sh
